<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>WWMap</title>
    <link rel="stylesheet" href="css/bootstrap.min.css"/>
    <link rel="stylesheet" href="css/index.css"/>
    <link rel="stylesheet" href="css/vex.css"/>
    <link rel="stylesheet" href="css/vex-theme-default.css"/>
    <link rel="stylesheet" href="css/jquery-te-1.4.0.css"/>
</head>
<body>
<header class="navbar navbar-light navbar-static-top bd-navbar">
    <div class="container">
        <nav>
            <div class="clearfix">
                <button class="navbar-toggler float-xs-right hidden-sm-up" type="button" data-toggle="collapse"
                        data-target="#bd-main-nav" aria-controls="bd-main-nav" aria-expanded="false"
                        aria-label="Toggle navigation"></button>
                <a class="navbar-brand hidden-sm-up" href="/">
                    Home
                </a>
            </div>
            <div class="collapse navbar-toggleable-xs" id="bd-main-nav">
                <ul class="nav navbar-nav">
                    <li class="nav-item">
                        <a class="nav-item nav-link" href="./index.htm"
                           onclick="ga('send', 'event', 'Navbar', 'Community links', 'Bootstrap');">Карта</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-item nav-link" href="./upload.htm"
                           onclick="ga('send', 'event', 'Navbar', 'Community links', 'Bootstrap');">Новая история</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-item nav-link" href="./about.htm"
                           onclick="ga('send', 'event', 'Navbar', 'Community links', 'Bootstrap');">О проекте</a>
                    </li>
                </ul>
            </div>
        </nav>
    </div>
</header>

<h2 id="pageTitle">Трек без названия</h2>
<div style="height: 30px;"></div>
<div class="container-fluid">
    <div class="row">
        <div class="col-sm-8">
            <div id="map" style="witdh:800px; height: 400px; margin: 10px;"></div>
        </div>
        <div class="col-sm-4">
            <ul id="tracks" class="trackMenu"></ul>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-11">
            <div id="articles" class="articles-container">

            </div>
        </div>
    </div>
</div>

<div id="article-editor" style="display: none;">
    <textarea name="article" class="editorEx"></textarea>
</div>

<script type="text/javascript" src="./js/jquery-3.1.1.min.js"></script>
<script type="text/javascript" src="./js/jquery.tmpl.js"></script>
<script type="text/javascript" src="./js/tether.min.js"></script>
<script type="text/javascript" src="./js/bootstrap.min.js"></script>
<script type="text/javascript" src="./js/jquery.cookie.js"></script>
<script type="text/javascript" src="./js/jquery.json.js"></script>
<script type="text/javascript" src="./js/vex.combined.min.js"></script>
<script type="text/javascript" src="./js/jquery-te-1.4.0.min.js"></script>

<script type="text/javascript" src="http://jqueryte.com/js/jquery.snippet.min.js" charset="utf-8"></script>
<script type="text/javascript" src="http://jqueryte.com/js/site.js" charset="utf-8"></script>

<script type="text/javascript" src="https://api-maps.yandex.ru/2.1/?lang=tr_TR"></script>
<script type="text/javascript">
    $.urlParam = function (name) {
        var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
        return results[1] || 0;
    };

    const apiBase = "http://localhost:7007";
    const id = $.urlParam('id');

    const PHOTO = 'photo';
    const VIDEO = 'video';
    const POST = 'post';


    ymaps.ready(init);
    var myMap;
    var objectManager;

    vex.defaultOptions.className = 'vex-theme-default'

    function init() {
        myMap = new ymaps.Map("map", {
            center: [55.76, 37.64],
            zoom: 8,
            controls: ["zoomControl", "fullscreenControl"]
        });

        $.get(apiBase + '/track-editor-page?id=' + id, function (data) {
            page = $.parseJSON(data);
            $('#pageTitle').html(page.title);
            myMap.setBounds(page.trackBounds);
            for (var i in page.eventPoints) {
                var eventPointId = page.eventPoints[i].id;
                var content = page.eventPoints[i].content;
                var type = page.eventPoints[i].type;
                var articleHtml = mkWrappedHtml(eventPointId, type, content);

                $('#articles').append(articleHtml);

                $('body').on('input', '.monitored-img-url', throttle(fetchImgOptions, 1500));
            }
        });

        function throttle(func, interval) {
            var lastCall = 0;
            return function (args) {
                var now = Date.now();
                if (lastCall + interval < now) {
                    lastCall = now;
                    return func(args);
                }
            };
        }

        myMap.events.add('click', showMapMenu);
        myMap.events.add('contextmenu', showMapMenu);

        objectManager = new ymaps.LoadingObjectManager(apiBase + '/single-track-tile?id=' + id, {
            geoObjectHasBalloon: false,
            splitRequests: true,
            geoObjectStrokeWidth: 3
        });
        addContextMenu(objectManager);


        myMap.geoObjects.add(objectManager);

    }

    function showMapMenu(e) {
        var coords = e.get('coords');

        // remove context menu
        $('#menu').remove();

        vex.dialog.open({
                    buttons: [
                        $.extend({}, vex.dialog.buttons.YES, {text: 'Фото', click: vexButtonVal(PHOTO)}),
                        $.extend({}, vex.dialog.buttons.YES, {text: 'Видео', click: vexButtonVal(VIDEO)}),
                        $.extend({}, vex.dialog.buttons.YES, {
                            text: 'Запись',
                            click: vexButtonVal(POST),
                            className: 'vex-dialog-button-primary'
                        })
                    ],
                    callback: function (type) {
                        showAddOrEditDialog(coords, "", type, "", addPlacemark)
                    }
                }
        );
    }

    function showAddOrEditDialog(coords, content, type, title, editFunc) {
        if (!type) {
            return
        }
        switch (type) {
            case PHOTO:
                vex.dialog.open({
                    input: '<label for="url">Прямая ссылка на фото в интернете</label>' +
                    '<input id="url" style="width: 100%" class="monitored-img-url" name="url" value="' + content + '"/>' +
                    '<div id="img_options" style="margin-top: 8px;"></div>',
                    callback: function (value) {
                        if (value) {
                            editFunc(coords, value.url, type, "")
                        }
                    }
                });
                break;
            case VIDEO:
                vex.dialog.prompt({
                    placeholder: 'Ссылка на youtube',
                    callback: function (value) {
                        if (value) {
                            editFunc(coords, value, type, "")
                        }
                    }
                });
                break;
            case POST:
                vex.dialog.open({
                    input: '<textarea name="article" class="editorEx">' + content + '</textarea>',
                    callback: function (articleData) {
                        if (articleData) {
                            editFunc(coords, articleData['article'], type, "")
                        }
                    },
                    contentClassName: 'vex-wide'
                });
                $(".editorEx").jqte();
                break;
            default:
                vex.dialog.alert('Это ещё не сделано!')
        }
    }

    function fetchImgOptions(e) {
        var url = $(e.target).val();
        $.post(apiBase + '/picture-metadata', url.trim(), function (data) {
            var imgOptions = $('#img_options');
            imgOptions.html("");
            metadata = $.parseJSON(data);
            if (metadata.timestamp) {
                imgOptions.append("<p><b>Дата снимка: </b>" + metadata.timestamp + "</p>");
            }
            if (metadata.coords) {
                imgOptions.append("<p><b>Место снимка: </b>" + metadata.coords + "</p>");
            }
        });
    }

    function addPlacemark(coords, content, type, title) {
        $.post(apiBase + '/point', {
            track_id: id,
            type: type,
            title: title,
            content: content,
            point: JSON.stringify(coords)
        }, function (eventPointId) {
            // this workaround used to prevent data reload on placemark add.
            // there is screen flicker on data reload
            var placemark = new ymaps.Placemark(coords, {
                id: eventPointId,
                type: type,
            }, {});

            switch (type) {
                case VIDEO:
                    placemark.options.set({preset: 'islands#blueVideoIcon'});
                    break;
                case PHOTO:
                    placemark.options.set({preset: 'islands#blueVegetationIcon'});
                    break;
                case POST:
                    placemark.options.set({preset: 'islands#blueBookIcon'});
                    break
            }

            var articleHtml = mkWrappedHtml(eventPointId, type, content);

            addContextMenu(placemark);
            myMap.geoObjects.add(placemark);

            $('#articles').append(articleHtml);
        });
    }

    function modifyPlacemark(id, coords, content, type, title) {
        $.ajax({
            url: apiBase + '/point/' + id,
            type: 'PUT',
            data: {
                track_id: id,
                type: type,
                title: title,
                content: content,
                point: JSON.stringify(coords)
            }
        }).done(function (data) {
            var pointData = $.parseJSON(data);
            $('#article' + pointData.id).html(mkHtml(pointData.type, pointData.content))
        });
    }

    function mkWrappedHtml(id, type, content) {
        return '<p id="article' + id + '" class="' + type + '-article">' + mkHtml(type, content) + "</p>"
    }

    function mkHtml(type, content) {
        switch (type) {
            case VIDEO:
                return mkVideoHtml(content);
            case PHOTO:
                return mkPhotoHtml(content);
            case POST:
                return mkPostHtml(content);
        }
    }

    function mkPostHtml(content) {
        return content;
    }

    function mkPhotoHtml(content) {
        return '<img src="' + content + '"/>';
    }

    function mkVideoHtml(content) {
        return 'Not supported yet';
    }

    function vexButtonVal(val) {
        return function ($vexContent, event) {
            this.value = val;
            this.close();
        };
    }

    function addContextMenu(obj) {
        // Контекстное меню, позволяющее изменить параметры метки.
        // Вызывается при нажатии правой кнопкой мыши на метке.
        obj.events.add('contextmenu', showContextMenu);
        obj.events.add('click', showContextMenu);
    }

    function showContextMenu(e) {
        placemark = e.get("target");
        // Если меню метки уже отображено, то убираем его.
        if ($('#menu').css('display') == 'block') {
            $('#menu').remove();
        } else {
            // HTML-содержимое контекстного меню.
            var menuContent =
                    '<div id="menu">\
                    <div align="center"><input type="submit" name="editPlacemark" value="Редактировать"/></div>\
                    <div align="center"><input type="submit" name="delPlacemark" value="Удалить"/></div>\
                    </div>';

            // Размещаем контекстное меню на странице
            $('body').append(menuContent);

            // Задаем позицию меню.
            $('#menu').css({
                left: e.get('pagePixels')[0],
                top: e.get('pagePixels')[1]
            });

            $('#menu input[name="delPlacemark"]').click(function () {
                // id of object loaded by object manager
                var objectManagerPlacemarkId = e.get("objectId");
                var newlyCreatedPlacemarkId = placemark.properties ? placemark.properties.get("id") : null;
                var placemarkId = objectManagerPlacemarkId ? objectManagerPlacemarkId : newlyCreatedPlacemarkId;

                $.ajax({
                    url: apiBase + '/point/' + placemarkId,
                    type: 'DELETE',
                    success: function (result) {
                        if (newlyCreatedPlacemarkId) {
                            myMap.geoObjects.remove(placemark);
                        }
                        if (objectManagerPlacemarkId) {
                            objectManager.reloadData();
                        }
                        $('#article' + placemarkId).remove()
                    }
                });
                $('#menu').remove();
            });

            $('#menu input[name="editPlacemark"]').click(function () {
                // id of object loaded by object manager
                var objectManagerPlacemarkId = e.get("objectId");
                var newlyCreatedPlacemarkId = placemark.properties ? placemark.properties.get("id") : null;
                var placemarkId = objectManagerPlacemarkId ? objectManagerPlacemarkId : newlyCreatedPlacemarkId;

                $.get(apiBase + '/point/' + placemarkId, function (data) {
                    var pointData = $.parseJSON(data);
                    var coords = e.get('coords');

                    showAddOrEditDialog(coords, pointData.content, pointData.type, pointData.title,
                            function (coords, content, type, title) {
                                modifyPlacemark(pointData.id, pointData.point, content, pointData.type, title)
                            })
                });
                $('#menu').remove();
            });
        }
    }
</script>
</body>
</html>
