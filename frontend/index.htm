<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>WWMap</title>
    <link rel="stylesheet" href="css/bootstrap.min.css"/>
    <link rel="stylesheet" href="css/index.css"/>
</head>
<body>
<a href="./upload.htm">Upload</a>
<div style="height: 30px;"></div>
<div class="container">
    <div class="row">
        <div class="col-sm-8">
            <div id="map" style="witdh:800px; height: 600px; margin: 10px;"></div>
        </div>
        <div class="col-sm-4">
            <ul id="tracks" class="trackMenu"></ul>
        </div>
    </div>
</div>

<script type="text/x-jquery-tmpl" id="trackMenuTemplate">
    <li>
        <span class="title">${title}</span>
        <ul>
        {{each points}}
            <li><span class="time">${$value.time}</span> ${$value.title}</li>
        {{/each}}
        </ul>
    </li>
</script>

<script type="text/javascript" src="./js/jquery-3.1.1.min.js"></script>
<script type="text/javascript" src="./js/jquery.tmpl.js"></script>
<script type="text/javascript" src="./js/tether.min.js"></script>
<script type="text/javascript" src="./js/bootstrap.min.js"></script>
<script type="text/javascript" src="./js/jquery.cookie.js"></script>
<script type="text/javascript" src="./js/jquery.json.js"></script>
<script type="text/javascript" src="https://api-maps.yandex.ru/2.1/?lang=tr_TR"></script>
<script type="text/javascript">
    const LAST_POS_COOKIE_NAME = "last-map-pos";
    const apiBase = "http://localhost:7007";

    ymaps.ready(init);
    var myMap;

    function trackList(tracks) {
        $('#tracks').html('')
        $('#trackMenuTemplate').tmpl(tracks).appendTo('#tracks');
    }

    function init() {
        myMap = new ymaps.Map("map", {
            center: lastPosition(),
            zoom: 7,
            controls: ["zoomControl", "fullscreenControl"]
        });

        myMap.events.add('boundschange', function (e) {
            $.cookie(LAST_POS_COOKIE_NAME, $.toJSON(myMap.getCenter()), { path: window.location.origin })
        });
        myMap.events.add('click', function (e) {
            myMap.balloon.close()
        });

        var objectManager = new ymaps.LoadingObjectManager(apiBase + '/tile?bbox=%b', {
            clusterHasBalloon: false,
            geoObjectOpenBalloonOnClick: false,
            splitRequests: true
        });

        objectManager.objects.events.add(['click'], function (e) {
            objectManager.objects.balloon.open(e.get('objectId'));
        });

        myMap.geoObjects.add(objectManager);

    }

    function lastPosition() {
        lastPos = $.cookie(LAST_POS_COOKIE_NAME);
        if (lastPos) {
            return $.parseJSON(lastPos)
        } else {
            return [55.76, 37.64]
        }
    }
</script>
</body>
</html>
