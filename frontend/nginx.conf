upstream osm_upstream {
        server localhost:7008;
}

upstream backend {
        server localhost:7007;
}

server {
        listen 80 default_server;
        listen [::]:80 default_server;

        root /var/lib/wwmap/frontend;

        # Add index.php to the list if you are using PHP
        index index.html index.htm index.nginx-debian.html;

        server_name wwmap.ru;

        location /maps/ {
                proxy_pass http://localhost:7008/;
                expires max;
                add_header Cache-Control public;
	            proxy_set_header X-Real-IP $remote_addr;
	       	    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        	    proxy_buffering off;
        }

        location / {
                return 301 https://$host$request_uri;
        }

}

server {
        listen 443;
        listen [::]:443;
        ssl on;
        ssl_certificate /etc/ssl/certs/wwmap.crt;
        ssl_certificate_key /etc/ssl/private/wwmap.key;

        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Host $server_name;
        proxy_set_header   X-Forwarded-Proto https;

        server_name wwmap.ru;
        root /var/lib/wwmap/frontend;

        location /editor/ {
                try_files $uri $uri/ =404;
                expires 10m;
		        index editor.htm;
                alias /var/lib/wwmap/frontend-2/;
        }

        location /api/ {
                proxy_pass http://backend/;
                expires 1h;
                add_header Cache-Control public;
        }

        location /editor-api/ {
                proxy_pass http://backend/;

                # turn cache off
                add_header Last-Modified $date_gmt;
                add_header Cache-Control 'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0';
                if_modified_since off;
                expires off;
                etag off;
        }

        location / {
                try_files $uri $uri/ =404;
                add_header Access-Control-Allow-Origin *;
                expires 10m;
		        index map.htm;
        }
}

